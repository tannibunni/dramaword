# 🔍 自动IP检测使用指南

## 📋 概述

为了解决网络环境变化时手动更新IP地址的麻烦，我们实现了自动IP检测功能。现在应用可以：

1. **启动时自动检测** - 应用启动时自动检测后端服务器IP
2. **网络错误时重试** - 连接失败时自动尝试新的IP地址
3. **手动刷新** - 在设置页面手动刷新IP地址
4. **脚本自动化** - 使用脚本自动更新环境配置

## 🚀 使用方法

### 方法1：自动启动（推荐）

```bash
# 自动检测IP并启动开发服务器
npm run dev:auto

# 或者
npm run start:auto
```

### 方法2：手动检测

```bash
# 只检测和更新IP配置
npm run auto-ip
```

### 方法3：应用内刷新

1. 打开应用
2. 进入设置页面
3. 点击"刷新IP地址"按钮

## 🔧 工作原理

### 自动检测流程

1. **缓存优先** - 首先尝试使用上次成功的IP地址
2. **并行检测** - 同时检测多个常见IP地址段
3. **智能回退** - 如果检测失败，使用默认IP地址
4. **实时更新** - 网络错误时自动重新检测

### 支持的IP段

- `192.168.1.x` - 常见家庭网络
- `192.168.0.x` - 常见路由器默认段
- `192.168.2.x` - 扩展网络段
- `10.0.x.x` - 企业网络段
- `172.16.x.x` - 企业网络段

## 📱 应用内功能

### 状态指示器

主页顶部显示当前连接状态：
- 🟢 **已连接** - 显示当前IP地址
- 🟡 **未连接** - 显示连接失败
- 🔄 **初始化中** - 正在检测IP

### 设置页面

在设置 → 网络连接中：
- **刷新IP地址** - 手动触发IP检测
- **检测状态** - 显示检测进度

## 🛠️ 故障排除

### 常见问题

1. **检测失败**
   - 确保后端服务器正在运行
   - 检查防火墙设置
   - 确认网络连接正常

2. **IP地址不正确**
   - 手动运行 `npm run auto-ip`
   - 检查后端服务器端口（默认3000）
   - 确认健康检查端点 `/health` 可访问

3. **应用无法连接**
   - 重启应用
   - 在设置中手动刷新IP
   - 检查后端服务器状态

### 调试信息

查看控制台日志：
```bash
# 启动时查看详细日志
EXPO_DEBUG=1 npm run dev:auto
```

### 手动配置

如果自动检测失败，可以手动设置：

1. 编辑 `mobile/.env` 文件
2. 设置 `EXPO_PUBLIC_API_URL=http://你的IP:3000/api`
3. 重启应用

## 🔄 网络环境变化

### 切换WiFi网络

1. 应用会自动检测新网络
2. 如果检测失败，手动刷新IP
3. 或者重启应用

### 移动热点

1. 确保手机和电脑在同一网络
2. 使用 `npm run auto-ip` 检测新IP
3. 重启应用

### 公司网络

1. 可能需要配置代理
2. 检查防火墙规则
3. 联系网络管理员

## 📊 性能优化

### 检测速度

- 并行检测多个IP地址
- 2秒超时设置
- 缓存成功结果

### 网络效率

- 只检测健康检查端点
- 避免不必要的请求
- 智能重试机制

## 🔐 安全考虑

- 只检测本地网络IP
- 不存储敏感信息
- 使用HTTPS（生产环境）

## 📝 更新日志

- **v1.0.0** - 初始版本，基础IP检测
- **v1.1.0** - 添加并行检测和缓存
- **v1.2.0** - 集成应用内刷新功能
- **v1.3.0** - 添加自动化脚本

---

💡 **提示**: 建议在开发环境中使用 `npm run dev:auto` 命令，这样可以自动处理IP变化问题。 